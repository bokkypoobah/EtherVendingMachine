var GAZECOINMETAVERSEASSETADDRESS = "0x2667E5192Bac646A165b7E4f717A7F1c0418CC27";
var GAZECOINMETAVERSEASSETABI =[{"constant":true,"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"string","name":"uri","type":"string"}],"name":"setTokenURI","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"string","name":"key","type":"string"}],"name":"removeAttribute","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"numberOfAttributes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"getAttributeByIndex","outputs":[{"internalType":"bool","name":"_exists","type":"bool"},{"internalType":"string","name":"_key","type":"string"},{"internalType":"string","name":"_value","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"string","name":"key","type":"string"},{"internalType":"string","name":"value","type":"string"}],"name":"addAttribute","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenOfOwnerByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"burn","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"string","name":"tokenURI","type":"string"}],"name":"mintWithTokenURI","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"string","name":"uri","type":"string"}],"name":"setBaseURI","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"to","type":"address"}],"name":"mint","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"baseURI","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"acceptOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"_newOwner","type":"address"}],"name":"transferOwnershipImmediately","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"_data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"newOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"string","name":"key","type":"string"},{"internalType":"string","name":"value","type":"string"}],"name":"updateAttribute","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"string","name":"key","type":"string"},{"indexed":false,"internalType":"string","name":"value","type":"string"},{"indexed":false,"internalType":"uint256","name":"totalAfter","type":"uint256"}],"name":"AttributeAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"string","name":"key","type":"string"},{"indexed":false,"internalType":"uint256","name":"totalAfter","type":"uint256"}],"name":"AttributeRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"string","name":"key","type":"string"},{"indexed":false,"internalType":"string","name":"value","type":"string"}],"name":"AttributeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"_from","type":"address"},{"indexed":true,"internalType":"address","name":"_to","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"}];

const GazeCoinBuilder = {
  template: `
  <div>
    <div>
      <b-row>
        <b-col cols="12" md="8">
          <b-card title="GazeCoin Builder" sub-title="Your Assets">
            <b-form @submit="onSubmit" v-if="show">
              <!--
              <b-row no-gutters v-for="(item, key, index) in items">
                <b-col cols="1">{{ key }}</b-col>
                <b-col class="truncate">
                  <b-link :href="explorer + 'token/' + itemn.tokenId" class="card-link" target="_blank">{{ item }}</b-link>
                </b-col>
              </b-row>
              -->
              <b-table striped hover :items="items"></b-table>

              <!--
              <b-form-group id="symbolInputGroup" label-for="symbolInput" label="Symbol" label-cols="4" description="An uppercase word a few letters long">
                <b-form-input id="symbolInput" type="text" :value.trim="symbol" @input="updateSymbol" required placeholder="example '${DEFAULTSYMBOL}'"></b-form-input>
              </b-form-group>
              <b-form-group id="nameInputGroup" label-for="nameInput" label="Name" label-cols="4" description="A set of mixed case words">
                <b-form-input id="nameInput" type="text" :value.trim="name" @input="updateName" required placeholder="example '${DEFAULTNAME}'"></b-form-input>
              </b-form-group>
              <b-form-group id="decimalsInputGroup" label-for="decimalsInput" label="Decimals" label-cols="4" description="Number of decimal places, between 0 and 18, inclusive">
                <b-form-input id="decimalsInput" type="number" step="1" :value.trim="decimals" @input="updateDecimals" required placeholder="example '${DEFAULTDECIMALS}'"></b-form-input>
              </b-form-group>
              <b-form-group id="totalSupplyInputGroup" label-for="totalSupplyInput" label="Total Supply" label-cols="4" description="A positive number less than or equals to 100,000,000,000,000">
                <b-form-input id="totalSupplyInput" type="number" step="any" :value.trim="totalSupply" @input="updateTotalSupply" required placeholder="example '${DEFAULTTOTALSUPPLY}'"></b-form-input>
              </b-form-group>
              <b-form-group id="deploymentFeeInputGroup" label-for="deploymentFeeInput" label="Deployment Fee" label-cols="4" description="Minimum deployment fee 0.1 ethers">
                <b-form-input id="deploymentFeeInput" type="number" step="0.000000001" :value.trim="deploymentFee" @input="updateDeploymentFee" required placeholder="example '${DEFAULTMINIMUMFEE}'"></b-form-input>
              </b-form-group>
              <b-form-group label="Show Details: " label-cols="4">
                <b-form-radio-group id="showDetails" v-model="showDetails" name="transactionDataTypeComponent">
                  <b-form-radio value="none" v-b-popover.hover.top="'Dont show any details'">None</b-form-radio>
                  <b-form-radio value="functionCall" v-b-popover.hover.top="'For executing using the geth JavaScript console'">Function Call</b-form-radio>
                  <b-form-radio value="javascript" v-b-popover.hover.top="'For executing using the geth JavaScript console'">JavaScript</b-form-radio>
                  <b-form-radio value="formatted" v-b-popover.hover.top="'For displaying the chunks of raw data'">Formatted</b-form-radio>
                  <b-form-radio value="raw" v-b-popover.hover.top="'This raw data can be copied into MyCrypto or MyEtherWallet for deployment'">Raw</b-form-radio>
                </b-form-radio-group>
              </b-form-group>
              <b-form-group id="transactionDataInputGroup" label-cols="4" label-for="transactionDataInput" v-if="showDetails != 'none'" label="Transaction details" :description="getDescription">
                <b-form-textarea id="transactionDataInput" v-model.trim="getTransactionData" plaintext :wrap="showDetails === 'raw' ? 'soft' : 'off'" rows="10" max-rows="20" ></b-form-textarea>
              </b-form-group>
              -->
              <b-form-group>
                <b-button type="submit" id="deploy" :disabled="actionDeploy === true" variant="primary">{{ actionDeploy === true ? "Doing something ... " : "Do something (TODO)" }}</b-button>
              </b-form-group>
              <b-form-group>
                <b-button v-show="deploymentTx" :href="explorer + 'tx/' + deploymentTx" variant="success" target="_blank">View transaction {{ deploymentTx }}</b-button>
              </b-form-group>
              <b-form-group>
                <b-button v-show="deploymentTxError" variant="danger">{{ deploymentTxError }}</b-button>
              </b-form-group>
            </b-form>
          </b-card>
        </b-col>
        <b-col cols="12" md="4">
          <connection></connection>
          <br />
          <b-card v-if="show" title="GazeCoin Metaverse Assets">
            <b-row>
              <b-col cols="4">NFT Contract</b-col><b-col class="truncate" cols="8"><b-link :href="explorer + 'token/' + nftAddress" class="card-link" target="_blank">{{ nftAddress }}</b-link></b-col>
            </b-row>
            <b-row>
              <b-col cols="4">Symbol</b-col><b-col class="truncate" cols="8">{{ symbol }}</b-link></b-col>
            </b-row>
            <b-row>
              <b-col cols="4">Name</b-col><b-col class="truncate" cols="8">{{ name }}</b-link></b-col>
            </b-row>
            <b-row>
              <b-col cols="4">Your assets</b-col><b-col class="truncate" cols="8"><b-link :href="explorer + 'token/' + nftAddress + '?a=' + coinbase" class="card-link" target="_blank">{{ balanceOf }}</b-link></b-col>
            </b-row>
            <b-row>
              <b-col cols="4">All assets</b-col><b-col class="truncate" cols="8"><b-link :href="explorer + 'token/' + nftAddress" class="card-link" target="_blank">{{ totalSupply }}</b-link></b-col>
            </b-row>
            <!--
            <div>Latest deployed token contracts (max {{ factoryDisplayMaxChildren + ' of ' + factoryNumberOfChildren }})</div>
            <b-row no-gutters v-for="(child) in factoryChildren">
              <b-col cols="1">{{ child.number }}</b-col>
              <b-col class="truncate">
                <b-link :href="explorer + 'token/' + child.address" class="card-link" target="_blank">{{ child.symbol + ':' + child.name + ':' + child.decimals + ':' + child.totalSupplyString + ':' + child.address.substring(0, 10) }}</b-link>
              </b-col>
            </b-row>
            -->
          </b-card>
        </b-col>
      </b-row>
    </div>
  </div>
  `,
  data: function () {
    return {
      show: true,
    }
  },
  computed: {
    symbol() {
      return store.getters['gazeCoinBuilder/symbol'];
    },
    name() {
      return store.getters['gazeCoinBuilder/name'];
    },
    explorer () {
      return store.getters['connection/explorer'];
    },
    nftAddress() {
      return store.getters['gazeCoinBuilder/nftAddress'];
    },
    totalSupply() {
      return store.getters['gazeCoinBuilder/totalSupply'];
    },
    balanceOf() {
      return store.getters['gazeCoinBuilder/balanceOf'];
    },
    items() {
      return store.getters['gazeCoinBuilder/items'];
    },
    coinbase() {
      return store.getters['connection/coinbase'];
    },
  },
  methods: {
    updateSymbol (e) {
      this.$store.commit('viewTokens/updateSymbol', e);
    },
    onSubmit(event) {
      event.preventDefault();
      this.$store.commit('deployTokenContract/updateActionDeploy', true);
    },
  },
  mounted() {
  },
};

const gazeCoinBuilderModule = {
  namespaced: true,
  state: {
    nftAddress: GAZECOINMETAVERSEASSETADDRESS,
    symbol: "DEFAULTSYMBOL",
    name: "DEFAULTNAME",
    totalSupply: "0",
    balanceOf: "0",
    items: [],
    executing: false,
  },
  getters: {
    nftAddress: state => state.nftAddress,
    symbol: state => state.symbol,
    name: state => state.name,
    totalSupply: state => state.totalSupply,
    balanceOf: state => state.balanceOf,
    items: state => state.items,
  },
  mutations: {
    updateSymbol (state, symbol) {
      state.symbol = symbol;
      logIt("deployTokenContractModule", "updateSymbol('" + symbol + "')")
    },
    updateName (state, name) {
      state.name = name;
      logIt("deployTokenContractModule", "updateName('" + name + "')")
    },
    updateTotalSupply (state, totalSupply) {
      state.totalSupply = totalSupply;
      logIt("deployTokenContractModule", "updateTotalSupply('" + totalSupply + "')")
    },
    updateBalanceOf (state, balanceOf) {
      state.balanceOf = balanceOf;
      logIt("deployTokenContractModule", "updateBalanceOf('" + balanceOf + "')")
    },
    updateItems (state, items) {
      Vue.set(state, 'items', items);
      logIt("deployTokenContractModule", "updateItems('" + Object.keys(items).length + "' items)");
    },
    updateExecuting (state, executing) {
      state.executing = executing;
      logIt("deployTokenContractModule", "updateExecuting('" + executing + "')")
    },
  },
  actions: {
    async execWeb3 ({state, commit}, {count, networkChanged, blockChanged, coinbaseChanged}) {
      if (!state.executing) {
        commit('updateExecuting', true);
        logIt("gazeCoinBuilderModule", "execWeb3() start[" + count + ", " + networkChanged + ", " + blockChanged + ", " + coinbaseChanged + "]");
        var contract = web3.eth.contract(GAZECOINMETAVERSEASSETABI).at(state.nftAddress);
        if (networkChanged || blockChanged || coinbaseChanged) {
          var _symbol = promisify(cb => contract.symbol(cb));
          var symbol = await _symbol;
          if (symbol !== state.symbol) {
            commit('updateSymbol', symbol);
          }
          var _name = promisify(cb => contract.name(cb));
          var name = await _name;
          if (name !== state.name) {
            commit('updateName', name);
          }
          var _totalSupply = promisify(cb => contract.totalSupply(cb));
          var totalSupply = await _totalSupply;
          if (!totalSupply.equals(state.totalSupply)) {
            commit('updateTotalSupply', totalSupply);
          }
          var coinbase = store.getters['connection/coinbase'];
          var _balanceOf = promisify(cb => contract.balanceOf(coinbase, cb));
          var balanceOf = await _balanceOf;
          if (!balanceOf.equals(state.balanceOf)) {
            commit('updateBalanceOf', balanceOf);
          }
          var i;
          var items = [];
          for (i = 0; i < balanceOf; i++) {
            logIt("gazeCoinBuilderModule", "execWeb3() token " + i);
            var _tokenId = promisify(cb => contract.tokenOfOwnerByIndex(coinbase, i, cb));
            var tokenId = await _tokenId;
            logIt("gazeCoinBuilderModule", "execWeb3() token " + i + " has tokenId #" + tokenId);
            var _numberOfAttributes = promisify(cb => contract.numberOfAttributes(tokenId, cb));
            var numberOfAttributes = await _numberOfAttributes;
            logIt("gazeCoinBuilderModule", "execWeb3() token " + i + " has tokenId #" + tokenId + " with " + numberOfAttributes + " attributes");
            var attributes = {};
            var j;
            for (j = 0; j < numberOfAttributes; j++) {
              var _attribute = promisify(cb => contract.getAttributeByIndex(tokenId, j, cb));
              var attribute = await _attribute;
              logIt("gazeCoinBuilderModule", "execWeb3()   attribute " + j + " " + JSON.stringify(attribute));
              attributes[attribute[1]] = attribute[2];
            }
            var item = { tokenId: tokenId, attributes: attributes };
            items.push(item);
          }
          commit('updateItems', items);
        }
        commit('updateExecuting', false);
        logIt("gazeCoinBuilderModule", "execWeb3() items " + JSON.stringify(items));
        logIt("gazeCoinBuilderModule", "execWeb3() end[" + count + ", " + networkChanged + ", " + blockChanged + ", " + coinbaseChanged + "]");
      } else {
        logIt("gazeCoinBuilderModule", "execWeb3() already executing[" + count + ", " + networkChanged + ", " + blockChanged + ", " + coinbaseChanged + "]");
      }
    }
  },
};
